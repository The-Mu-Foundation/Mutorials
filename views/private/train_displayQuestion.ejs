<!-- This is the page to display questions on -->

<!-- ARGUMENTS:
    newQues - question object passed in to be displayed
    units - a list of the units that the user selected
    user - the player
    subject - the subject -->

<%- include("../partials/header") -%>
<%- include("../partials/navigation") -%>

<!-- javascript code -->
<script>

    $(document).ready(function () {

        // obtain hidden tag info [NOT IN USE RIGHT NOW]
        var type = $("#hiddentypetag").val();

		// hide skip dialogue code
		$("#skip-dialogue-1").show();
		$("#skip-dialogue-2").hide(0);

		// skip button confirm message
        $("#skip-button").click(function () {
            $("#skip-dialogue-2").show(1000);
			$("#skip-dialogue-1").hide(1000);
        });
		$("#no-skip").click(function () {
			$("#skip-dialogue-1").show(1000);
			$("#skip-dialogue-2").hide(1000);
        });

        // hide empty response messages
        $("#fr-answerblank").hide(0);
        $("#mc-answerblank").hide(0);

        // upon hitting submit button
        var response = "";
        $("#submit").click(function () {
            if(type == "mc") {

                // MULTIPLE CHOICE RESPONSE CHECK
                //var choices = document.getElementById("mc-choices").elements;
                var choices = document.querySelectorAll('#mc-choices input[type="radio"]');
                for(let i = 0; i < choices.length; i++) {
                    if(choices[i].checked) {
                        response = choices[i].id;
                    }
                }

                if(response == "") {
                    $("#mc-answerblank").show(1000);
                }
            } else if(type == "sa") {

                // SELECT ALL REPSONSE CHECK
                response = [];
                //var choices = document.getElementById("sa-choices").elements;
                var choices = document.querySelectorAll('#sa-choices input[type="checkbox"]');
                for(let i = 0; i < choices.length; i++) {
                    if(choices[i].checked) {
                        response.push(choices[i].id);
                    }
                }

                if(response.length == 0) {
                    $("#mc-answerblank").show(1000);
                }
            } else if(type == "fr") {

                // FREE RESPONSE RESPONSE CHECK
                response = $("#fr-answer").val();

                if(response == "") {
                    $("#fr-answerblank").show(1000);
                }
            }

            // NOT POSTING WITH JQUERY; but if we did a post message would go here
        });
    });

</script>

<div class="jumbotron container mt-5">
    <%- include("../partials/flashes") -%>
    <% try { %>

        <!-- Test for faulty question -->
        <% if (!newQues) { %>
            <% throw "no questions found"; %>
        <% } %>
        <% if((newQues.question == "") || (newQues.rating == null) || (newQues.answer[0] == "") || (newQues.answer_ex == "")) { %>
            <% throw "bad question parameters"; %>
        <% } %>
        <p class="lead">
            <p style="color: #0275d8">Question Rating: <%= newQues.rating %></p>
            <p style="color: #0275d8">User Rating: <%= user.rating[subject.toLowerCase()] %></p>
            <% if(newQues.ext_source != "original") { %>
                <p>Question Source: <%= newQues.ext_source %></p>
            <% } %>
        </p>
        <!-- DISPLAY QUESTION -->
        <% if(newQues.type == "mc") { %>
            <!-- CODE FOR MULTIPLE CHOICE -->
            <h3 class="display-4" style="font-size: 1.5rem;">Please read the following question and select the best answer:</h3>
            <p><%- newQues.question %></p>
            <form action="/train/checkAnswer" method="POST">
                <div class="mt-4" id="mc-choices">
                    <% var choiceIndex = 1; %>
                    <% newQues.choices.forEach((choice) => { %>
                        <div class="custom-control custom-radio">
                            <input class="custom-control-input" type="radio" name="answerChoice" id="<%= choiceIndex %>" value="<%= choiceIndex %>">
                            <label class="custom-control-label" for="<%= choiceIndex %>"><%= String.fromCharCode(64+choiceIndex) %>. <%= choice %></label>
                        </div>
                        <% choiceIndex++; %>
                    <% }) %>
                    <input class="btn btn-primary mt-4" type="submit" value="Submit" id="submit">
                </div>
                <input type="hidden" name="id" value="<%= newQues._id %>">
                <input type="hidden" name="type" value="<%= newQues.type %>" id="hiddentypetag">
                <input type="hidden" name="subject" value="<%= subject %>">
                <input type="hidden" name="units" value="<%= units %>">
            </form>
        <% } else if(newQues.type == "sa") { %>
            <!-- CODE FOR SELECT ALL  -->
            <h3 class="display-4" style="font-size: 1.5rem;">Please read the following and select ALL choices that apply:</h3>
            <p><%- newQues.question %></p>
            <form action="/train/checkAnswer" method="POST">
                <div class="mt-4" id="sa-choices">
                    <% var choiceIndex = 1; %>
                    <% newQues.choices.forEach((choice) => { %>
                        <div class="custom-control custom-checkbox my-1 mr-sm-2">
                            <input type="checkbox" name="saChoice" class="custom-control-input" id="<%= choiceIndex %>" value="<%= choiceIndex %>">
                            <label class="custom-control-label" for="<%= choiceIndex %>"><%= String.fromCharCode(64+choiceIndex) %>. <%= choice %></label>
                        </div>
                        <% choiceIndex++; %>
                    <% }) %>
                    <input class="btn btn-primary mt-4" type="submit" value="Submit" id="submit">
                </div>
                <input type="hidden" name="id" value="<%= newQues._id %>">
                <input type="hidden" name="type" value="<%= newQues.type %>" id="hiddentypetag">
                <input type="hidden" name="subject" value="<%= subject %>">
                <input type="hidden" name="units" value="<%= units %>">
            </form>
        <% } else if(newQues.type == "fr") { %>
            <!-- CODE FOR FREE RESPONSE -->
            <h3 class="display-4" style="font-size: 1.5rem;">Please read the following question and enter your answer in the box:</h3>
            <p><%- newQues.question %></p>
            <form action="/train/checkAnswer" method="POST">
                <div class="mt-4">
                    <div class="form-group">
                        <input type="text" class="form-control" id="fr-answer" placeholder="Enter your answer here" name="freeAnswer">
                    </div>
                    <input class="btn btn-primary" type="submit" value="Submit" id="submit">
                </div>
                <input type="hidden" name="id" value="<%= newQues._id %>">
                <input type="hidden" name="type" value="<%= newQues.type %>" id="hiddentypetag">
                <input type="hidden" name="subject" value="<%= subject %>">
                <input type="hidden" name="units" value="<%= units %>">
            </form>
        <% } else { %>
            <% throw "invalid type"; %>
        <% } %>

        <h4 class="my-4" id="fr-answerblank"><font color="red">You haven't entered a response yet!</font></h4>
        <h4 class="my-4" id="mc-answerblank"><font color="red">You haven't selected an answer yet!</font></h4>

        <!--<h3 class="mt-4 mb-2">Additional Info</h3>-->

    <% } catch(err) { %>

        <!-- ERROR CODE -->
        <% if(err=="bad question parameters") { %>
            <h3>Someone messed up their equations! Perhaps they said $\sin^2(\theta)+\cos^2(\theta) \neq 1$ ?</h3>
            <p>Sorry, we could not display your question. Please reenter the trainer and inform an admin that the question with ID <font color="red"><%= newQues._id %></font> is dysfunctional.</p>

        <% } else { %>
            <h3>We're sorry, we weren't able to find any problems in this unit.</h3>
            <p>We're adding new problems constantly... Check back soon!</p>

            <a href="/train" class="btn btn-primary btn-block btn-lg mt-4">Click me to go back</a>
        <% } %>

</div>
<% if (typeof err == 'undefined') { %>
<div class="jumbotron container">

	<div id="skip-dialogue-1">
		<h3>Question's content out of reach of your knowledge?</h3>
		<button type="button" class="btn btn-primary mt-2" id="skip-button">Skip Question</button>
	</div>

	<div id="skip-dialogue-2">
		<h3>Are you sure you want to skip this question?</h3>
		<p>A new question will be randomly chosen, but you will lose 5 rating for skipping.</p>
		<button type="button" class="btn btn-secondary" id="no-skip">No</button>
		<a href="/train/<%= subject %>/display_question?units=<%=units%>"><button type="button" class="btn btn-primary" id="yes-skip">Yes</button></a>
	</div>

</div>
<% } %>

    <% } %>
<%- include("../partials/footer") -%>
